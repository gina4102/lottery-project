<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Admin 控制頁面</title>
  <style>
    body { font-family: 微軟正黑體; text-align:center; padding:50px; }
    input, button { padding:10px 20px; font-size:16px; margin:5px; }
    ul { list-style:none; padding:0; text-align:left; max-width:420px; margin:20px auto; }
    li.used { color: #aaa; text-decoration: line-through; }
  </style>
</head>
<body>
  <h1>Admin 控制頁面</h1>
  <p>可抽籤（ready → onStage / audience）</p>

  <input type="number" id="stageCountInput" placeholder="上台人數" min="1">
  <button id="drawBtn">抽籤</button>

  <ul id="participantsList">
    <li>候選人列表：</li>
  </ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // 初始化 Firebase（保持與其他頁一致）
    var firebaseConfig = {
      apiKey: "AIzaSyBBnbx00_d0Py6px-b_uZVrgpSapHNLiBo",
      authDomain: "lottery-test-b0021.firebaseapp.com",
      databaseURL: "https://lottery-test-b0021-default-rtdb.firebaseio.com",
      projectId: "lottery-test-b0021",
      storageBucket: "lottery-test-b0021.firebasestorage.app",
      messagingSenderId: "226750767626",
      appId: "1:226750767626:web:95bcb340e42cb0703575f3"
    };
    firebase.initializeApp(firebaseConfig);

    const participantsList = document.getElementById('participantsList');

    // 更新候選人列表
    function updateParticipantList() {
      firebase.database().ref('participants').once('value', snapshot => {
        const allUsers = snapshot.val() || {};
        participantsList.innerHTML = "<li><strong>候選人列表：</strong></li>";

        Object.keys(allUsers).forEach(id => {
          const p = allUsers[id];
          const li = document.createElement('li');

          const name = p.name || id;
          const age = p.age ? `（${p.age}歲）` : '';
          const status = p.status || '未準備';
          const used = p.used ? '（已抽過）' : '';

          li.textContent = `${name}${age} → ${status} ${used}`;
          if (p.used) li.classList.add('used');

          participantsList.appendChild(li);
        });
      });
    }

    updateParticipantList();
    setInterval(updateParticipantList, 2000);

    // 抽籤
    document.getElementById('drawBtn').addEventListener('click', () => {
      const stageCount =
        parseInt(document.getElementById('stageCountInput').value) || 2;

      firebase.database().ref('participants').once('value', snapshot => {
        const allUsers = snapshot.val() || {};

        // 只抽「準備好且未被抽過」的人
        const readyUsers = Object.keys(allUsers).filter(id => {
          const p = allUsers[id];
          return p.status === 'ready' && p.used !== true;
        });

        if (readyUsers.length === 0) {
          alert("沒有可抽籤的人！");
          return;
        }

        // 隨機排序
        readyUsers.sort(() => Math.random() - 0.5);

        const onStage = readyUsers.slice(0, stageCount);
        const audience = readyUsers.slice(stageCount);

        // 更新狀態
        onStage.forEach(id => {
          firebase.database().ref('participants/' + id).update({
            status: 'onStage',
            used: true
          });
        });

        audience.forEach(id => {
          firebase.database().ref('participants/' + id).update({
            status: 'audience'
          });
        });

        alert("抽籤完成！");
        updateParticipantList();
      });
    });
  </script>
</body>
</html>
