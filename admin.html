<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Admin 控制頁面</title>
</head>
<body>
  <h1>Admin 控制頁面</h1>
  <p>可抽籤 & 控制下一幕。</p>

  <input type="number" id="stageCountInput" placeholder="上台人數" min="1">
  <button id="drawBtn">抽籤</button>
  <button id="nextSceneBtn">下一幕</button>

  <ul id="participantsList"><li>候選人列表：</li></ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // 初始化 Firebase
    var firebaseConfig = {
      apiKey: "你的 apiKey",
      authDomain: "你的 authDomain",
      databaseURL: "你的 databaseURL",
      projectId: "你的 projectId",
      storageBucket: "你的 storageBucket",
      messagingSenderId: "你的 messagingSenderId",
      appId: "你的 appId"
    };
    firebase.initializeApp(firebaseConfig);

    const participantsList = document.getElementById('participantsList');

    // 顯示候選人
    function updateParticipantList() {
      firebase.database().ref('participants').once('value', snapshot => {
        const allUsers = snapshot.val() || {};
        const readyUsers = Object.keys(allUsers).filter(id => allUsers[id].status === 'ready');
        participantsList.innerHTML = "<li>候選人列表：</li>";
        readyUsers.forEach(id => {
          const li = document.createElement('li');
          li.textContent = id;
          participantsList.appendChild(li);
        });
      });
    }
    updateParticipantList();
    setInterval(updateParticipantList, 2000); // 每 2 秒更新一次列表

    // 抽籤功能
    document.getElementById('drawBtn').addEventListener('click', () => {
      const stageCount = parseInt(document.getElementById('stageCountInput').value) || 2;
      firebase.database().ref('participants').once('value', snapshot => {
        const allUsers = snapshot.val() || {};
        const readyUsers = Object.keys(allUsers).filter(id => allUsers[id].status === 'ready');

        // 隨機排序
        readyUsers.sort(() => Math.random() - 0.5);

        const onStage = readyUsers.slice(0, stageCount);
        const audience = readyUsers.slice(stageCount);

        // 更新 status
        onStage.forEach(id => firebase.database().ref('participants/' + id + '/status').set('onStage'));
        audience.forEach(id => firebase.database().ref('participants/' + id + '/status').set('audience'));

        alert("抽籤完成！");
      });
    });

    // 同步跳到下一幕
    document.getElementById('nextSceneBtn').addEventListener('click', () => {
      firebase.database().ref().update({ currentPage: 'nextScene' });
      alert("已更新所有觀眾到下一幕！");
    });
  </script>
</body>
</html>